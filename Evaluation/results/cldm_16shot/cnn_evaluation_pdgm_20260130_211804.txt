[INFO] Using specified domain: pdgm
[INFO] Using default mask root for pdgm: /home/j98my/Pre-Processing/prep/pdgm_target_aligned
Found 64 patient folders in /home/j98my/models/runs/ldm_3d_diffuse_glioma/new_LAT28_VAE200_50_LDM300_200_TUNE2_UNET96/final_samples_64/final_samples/pdgm
Using masks from: /home/j98my/Pre-Processing/prep/pdgm_target_aligned
Domain: PDGM
[MAP] s00000 (pid=UCSF-PDGM-0010) -> mask: UCSF-PDGM-0010
[MAP] s00001 (pid=UCSF-PDGM-0011) -> mask: UCSF-PDGM-0011
[MAP] s00002 (pid=UCSF-PDGM-0013) -> mask: UCSF-PDGM-0013
[MAP] s00003 (pid=UCSF-PDGM-0004) -> mask: UCSF-PDGM-0004
[MAP] s00004 (pid=UCSF-PDGM-0009) -> mask: UCSF-PDGM-0009
[MAP] s00005 (pid=UCSF-PDGM-0007) -> mask: UCSF-PDGM-0007
[MAP] s00006 (pid=UCSF-PDGM-0005) -> mask: UCSF-PDGM-0005
[MAP] s00007 (pid=UCSF-PDGM-0020) -> mask: UCSF-PDGM-0020
[MAP] s00008 (pid=UCSF-PDGM-0015) -> mask: UCSF-PDGM-0015
[MAP] s00009 (pid=UCSF-PDGM-0012) -> mask: UCSF-PDGM-0012
[MAP] s00010 (pid=UCSF-PDGM-0008) -> mask: UCSF-PDGM-0008
[MAP] s00011 (pid=UCSF-PDGM-0014) -> mask: UCSF-PDGM-0014
[MAP] s00012 (pid=UCSF-PDGM-0018) -> mask: UCSF-PDGM-0018
[MAP] s00013 (pid=UCSF-PDGM-0019) -> mask: UCSF-PDGM-0019
[MAP] s00014 (pid=UCSF-PDGM-0017) -> mask: UCSF-PDGM-0017
[MAP] s00015 (pid=UCSF-PDGM-0016) -> mask: UCSF-PDGM-0016
[MAP] s00016 (pid=UCSF-PDGM-0015) -> mask: UCSF-PDGM-0015
[MAP] s00017 (pid=UCSF-PDGM-0004) -> mask: UCSF-PDGM-0004
[MAP] s00018 (pid=UCSF-PDGM-0016) -> mask: UCSF-PDGM-0016
[MAP] s00019 (pid=UCSF-PDGM-0008) -> mask: UCSF-PDGM-0008
[MAP] s00020 (pid=UCSF-PDGM-0018) -> mask: UCSF-PDGM-0018
[MAP] s00021 (pid=UCSF-PDGM-0020) -> mask: UCSF-PDGM-0020
[MAP] s00022 (pid=UCSF-PDGM-0017) -> mask: UCSF-PDGM-0017
[MAP] s00023 (pid=UCSF-PDGM-0005) -> mask: UCSF-PDGM-0005
[MAP] s00024 (pid=UCSF-PDGM-0019) -> mask: UCSF-PDGM-0019
[MAP] s00025 (pid=UCSF-PDGM-0013) -> mask: UCSF-PDGM-0013
[MAP] s00026 (pid=UCSF-PDGM-0011) -> mask: UCSF-PDGM-0011
[MAP] s00027 (pid=UCSF-PDGM-0012) -> mask: UCSF-PDGM-0012
[MAP] s00028 (pid=UCSF-PDGM-0009) -> mask: UCSF-PDGM-0009
[MAP] s00029 (pid=UCSF-PDGM-0007) -> mask: UCSF-PDGM-0007
[MAP] s00030 (pid=UCSF-PDGM-0010) -> mask: UCSF-PDGM-0010
[MAP] s00031 (pid=UCSF-PDGM-0014) -> mask: UCSF-PDGM-0014
[MAP] s00032 (pid=UCSF-PDGM-0018) -> mask: UCSF-PDGM-0018
[MAP] s00033 (pid=UCSF-PDGM-0010) -> mask: UCSF-PDGM-0010
[MAP] s00034 (pid=UCSF-PDGM-0015) -> mask: UCSF-PDGM-0015
[MAP] s00035 (pid=UCSF-PDGM-0008) -> mask: UCSF-PDGM-0008
[MAP] s00036 (pid=UCSF-PDGM-0014) -> mask: UCSF-PDGM-0014
[MAP] s00037 (pid=UCSF-PDGM-0009) -> mask: UCSF-PDGM-0009
[MAP] s00038 (pid=UCSF-PDGM-0004) -> mask: UCSF-PDGM-0004
[MAP] s00039 (pid=UCSF-PDGM-0011) -> mask: UCSF-PDGM-0011
[MAP] s00040 (pid=UCSF-PDGM-0017) -> mask: UCSF-PDGM-0017
[MAP] s00041 (pid=UCSF-PDGM-0013) -> mask: UCSF-PDGM-0013
[MAP] s00042 (pid=UCSF-PDGM-0016) -> mask: UCSF-PDGM-0016
[MAP] s00043 (pid=UCSF-PDGM-0020) -> mask: UCSF-PDGM-0020
[MAP] s00044 (pid=UCSF-PDGM-0019) -> mask: UCSF-PDGM-0019
[MAP] s00045 (pid=UCSF-PDGM-0005) -> mask: UCSF-PDGM-0005
[MAP] s00046 (pid=UCSF-PDGM-0007) -> mask: UCSF-PDGM-0007
[MAP] s00047 (pid=UCSF-PDGM-0012) -> mask: UCSF-PDGM-0012
[MAP] s00048 (pid=UCSF-PDGM-0013) -> mask: UCSF-PDGM-0013
[MAP] s00049 (pid=UCSF-PDGM-0015) -> mask: UCSF-PDGM-0015
[MAP] s00050 (pid=UCSF-PDGM-0011) -> mask: UCSF-PDGM-0011
[MAP] s00051 (pid=UCSF-PDGM-0012) -> mask: UCSF-PDGM-0012
[MAP] s00052 (pid=UCSF-PDGM-0019) -> mask: UCSF-PDGM-0019
[MAP] s00053 (pid=UCSF-PDGM-0010) -> mask: UCSF-PDGM-0010
[MAP] s00054 (pid=UCSF-PDGM-0014) -> mask: UCSF-PDGM-0014
[MAP] s00055 (pid=UCSF-PDGM-0020) -> mask: UCSF-PDGM-0020
[MAP] s00056 (pid=UCSF-PDGM-0018) -> mask: UCSF-PDGM-0018
[MAP] s00057 (pid=UCSF-PDGM-0008) -> mask: UCSF-PDGM-0008
[MAP] s00058 (pid=UCSF-PDGM-0017) -> mask: UCSF-PDGM-0017
[MAP] s00059 (pid=UCSF-PDGM-0009) -> mask: UCSF-PDGM-0009
[MAP] s00060 (pid=UCSF-PDGM-0004) -> mask: UCSF-PDGM-0004
[MAP] s00061 (pid=UCSF-PDGM-0007) -> mask: UCSF-PDGM-0007
[MAP] s00062 (pid=UCSF-PDGM-0016) -> mask: UCSF-PDGM-0016
[MAP] s00063 (pid=UCSF-PDGM-0005) -> mask: UCSF-PDGM-0005
Built index: 3116 positive slices, 4052 negative slices from 64 patients.
Loading model from /home/j98my/models/runs/alexlite_dg_real_longrun/new_run/best.pt

======================================================================
ENHANCED EVALUATION WITH DOMAIN GAP ANALYSIS
======================================================================

STEP 1: Domain Adaptation Analysis
This separates domain gap from quality issues
----------------------------------------------------------------------

======================================================================
DOMAIN ADAPTATION ANALYSIS
======================================================================

Adaptation set: 10 samples
Test set: 7158 samples

1. Evaluating WITHOUT adaptation...
   AUC (no adaptation): 0.8817

2. Adapting model on 10 samples...
   Epoch 2/5, Loss: 1.3655
   Epoch 4/5, Loss: 1.7209

3. Evaluating WITH adaptation...
   AUC (with adaptation): 0.8778

======================================================================
DOMAIN GAP ANALYSIS
======================================================================
AUC without adaptation: 0.8817
AUC with adaptation:    0.8778
Domain gap effect:      -0.0039

Interpretation:
  Small domain gap - performance is mostly limited by
  intrinsic quality, not distribution shift.
======================================================================

STEP 2: Bootstrap Confidence Intervals
This provides robust uncertainty estimates
----------------------------------------------------------------------

======================================================================
BOOTSTRAP CONFIDENCE INTERVALS (1000 iterations)
======================================================================

Bootstrap Results:
  Mean:      0.8818
  Std Dev:   0.0040
  Median:    0.8818
  95% CI:    [0.8736, 0.8897]
  Range:     [0.8684, 0.8979]
======================================================================

STEP 3: Stratified Evaluation
This shows performance breakdown by subgroups
----------------------------------------------------------------------

======================================================================
STRATIFIED EVALUATION
======================================================================

Stratified Metrics:
  Overall AUC:                 0.8816
  Patient-level AUC:           0.9025 ± 0.1157
  Mean prob on positive:       0.8310
  Median prob on positive:     1.0000
  Mean prob on negative:       0.2290
  Median prob on negative:     0.0069
  N patients with both labels: 64
======================================================================


======================================================================
FINAL SUMMARY REPORT
======================================================================

DOMAIN: PDGM
Synthetic samples: 64
Total slices evaluated: 7168

1. BASIC PERFORMANCE:
   AUC: 0.8818 ± 0.0040
   95% CI: [0.8736, 0.8897]

2. DOMAIN GAP EFFECT:
   AUC without adaptation: 0.8817
   AUC with adaptation:    0.8778
   Domain gap:             -0.0039
   Interpretation: 0.004 of potential improvement
                   is achievable with 10 samples

3. PATIENT-LEVEL PERFORMANCE:
   Patient AUC: 0.9025 ± 0.1157

======================================================================
RECOMMENDATIONS FOR PAPER:
======================================================================
Report Accuracy as: {'accuracy': 0.8065011160714286, 'balanced_accuracy': 0.8083893657167984, 'auc': 0.8816018365865064, 'sensitivity': 0.8228498074454429, 'specificity': 0.793928923988154, 'f1': 0.7871066768994628, 'tp': 2564, 'tn': 3217, 'fp': 835, 'fn': 552}
Report AUC as: 0.882 ± 0.004
               [95% CI: 0.874, 0.890]

Note that 0.004 AUC points are due to domain
shift rather than quality, as evidenced by adaptation experiment.
======================================================================

Results saved to: /home/j98my/models/runs/ldm_3d_diffuse_glioma/new_LAT28_VAE200_50_LDM300_200_TUNE2_UNET96/final_samples_64/final_samples/pdgm/enhanced_evaluation_results.json
