[INFO] Using specified domain: gbm
[INFO] Using default mask root for gbm: /home/j98my/Pre-Processing/prep/gbm_all_aligned
Found 16 patient folders in /home/j98my/models/runs/ldm_3d_diffuse_glioma/10_shot_INFERENCE_TEST/test2_cfg12/final_samples/gbm
Using masks from: /home/j98my/Pre-Processing/prep/gbm_all_aligned
Domain: GBM
[MAP] s00000 (pid=UPENN-GBM-00078_11) -> mask: UPENN-GBM-00078_11
[MAP] s00001 (pid=UPENN-GBM-00549_11) -> mask: UPENN-GBM-00549_11
[MAP] s00002 (pid=UPENN-GBM-00303_11) -> mask: UPENN-GBM-00303_11
[MAP] s00003 (pid=UPENN-GBM-00326_11) -> mask: UPENN-GBM-00326_11
[MAP] s00004 (pid=UPENN-GBM-00008_11) -> mask: UPENN-GBM-00008_11
[MAP] s00005 (pid=UPENN-GBM-00531_11) -> mask: UPENN-GBM-00531_11
[MAP] s00006 (pid=UPENN-GBM-00287_11) -> mask: UPENN-GBM-00287_11
[MAP] s00007 (pid=UPENN-GBM-00248_11) -> mask: UPENN-GBM-00248_11
[MAP] s00008 (pid=UPENN-GBM-00014_11) -> mask: UPENN-GBM-00014_11
[MAP] s00009 (pid=UPENN-GBM-00374_11) -> mask: UPENN-GBM-00374_11
[MAP] s00010 (pid=UPENN-GBM-00320_11) -> mask: UPENN-GBM-00320_11
[MAP] s00011 (pid=UPENN-GBM-00094_11) -> mask: UPENN-GBM-00094_11
[MAP] s00012 (pid=UPENN-GBM-00068_11) -> mask: UPENN-GBM-00068_11
[MAP] s00013 (pid=UPENN-GBM-00040_11) -> mask: UPENN-GBM-00040_11
[MAP] s00014 (pid=UPENN-GBM-00442_11) -> mask: UPENN-GBM-00442_11
[MAP] s00015 (pid=UPENN-GBM-00257_11) -> mask: UPENN-GBM-00257_11
Built index: 793 positive slices, 999 negative slices from 16 patients.
Loading model from /home/j98my/models/runs/alexlite_dg_real_longrun/new_run/best.pt

======================================================================
ENHANCED EVALUATION WITH DOMAIN GAP ANALYSIS
======================================================================

STEP 1: Domain Adaptation Analysis
This separates domain gap from quality issues
----------------------------------------------------------------------

======================================================================
DOMAIN ADAPTATION ANALYSIS
======================================================================

Adaptation set: 10 samples
Test set: 1782 samples

1. Evaluating WITHOUT adaptation...
   AUC (no adaptation): 0.8338

2. Adapting model on 10 samples...
   Epoch 2/5, Loss: 0.0172
   Epoch 4/5, Loss: 0.1578

3. Evaluating WITH adaptation...
   AUC (with adaptation): 0.8315

======================================================================
DOMAIN GAP ANALYSIS
======================================================================
AUC without adaptation: 0.8338
AUC with adaptation:    0.8315
Domain gap effect:      -0.0023

Interpretation:
  Small domain gap - performance is mostly limited by
  intrinsic quality, not distribution shift.
======================================================================

STEP 2: Bootstrap Confidence Intervals
This provides robust uncertainty estimates
----------------------------------------------------------------------

======================================================================
BOOTSTRAP CONFIDENCE INTERVALS (1000 iterations)
======================================================================

Bootstrap Results:
  Mean:      0.8344
  Std Dev:   0.0098
  Median:    0.8344
  95% CI:    [0.8138, 0.8529]
  Range:     [0.7993, 0.8658]
======================================================================

STEP 3: Stratified Evaluation
This shows performance breakdown by subgroups
----------------------------------------------------------------------
Checking Mode collapse
Average pairwise similarity: 0.9924
Max similarity: 0.9993
Min similarity: 0.9632
⚠️  HIGH MODE COLLAPSE - Samples are too similar!

======================================================================
STRATIFIED EVALUATION
======================================================================

Stratified Metrics:
  Overall AUC:                 0.8348
  Patient-level AUC:           0.8356 ± 0.1932
  Mean prob on positive:       0.6688
  Median prob on positive:     0.9837
  Mean prob on negative:       0.1960
  Median prob on negative:     0.0058
  N patients with both labels: 16
======================================================================


======================================================================
FINAL SUMMARY REPORT
======================================================================

DOMAIN: GBM
Synthetic samples: 16
Total slices evaluated: 1792

1. BASIC PERFORMANCE:
   AUC: 0.8344 ± 0.0098
   95% CI: [0.8138, 0.8529]

2. DOMAIN GAP EFFECT:
   AUC without adaptation: 0.8338
   AUC with adaptation:    0.8315
   Domain gap:             -0.0023
   Interpretation: 0.002 of potential improvement
                   is achievable with 10 samples

3. PATIENT-LEVEL PERFORMANCE:
   Patient AUC: 0.8356 ± 0.1932

======================================================================
RECOMMENDATIONS FOR PAPER:
======================================================================
Report Accuracy as: {'accuracy': 0.7472098214285714, 'balanced_accuracy': 0.7354384649466617, 'auc': 0.8347647773877283, 'sensitivity': 0.6330390920554855, 'specificity': 0.8378378378378378, 'f1': 0.6890871654083733, 'tp': 502, 'tn': 837, 'fp': 162, 'fn': 291}
Report AUC as: 0.834 ± 0.010
               [95% CI: 0.814, 0.853]

Note that 0.002 AUC points are due to domain
shift rather than quality, as evidenced by adaptation experiment.
======================================================================

Results saved to: /home/j98my/models/runs/ldm_3d_diffuse_glioma/10_shot_INFERENCE_TEST/test2_cfg12/final_samples/gbm/enhanced_evaluation_results.json
